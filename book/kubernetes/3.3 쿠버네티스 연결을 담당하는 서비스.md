# 쿠버네티스 연결을 담당하는 서비스
- 쿠버네티스 클러스터 내부에서 파드를 사용할 수 있다. 또한 외부 사용자가 파드를 이용하는 방법도 있다.
- `서비스`: 외부에서 쿠버네티스 클러스터에 접속하는 방법 (소비를 위한 도움을 제공한다는 관점)

## ✅ 가장 간단하게 연결하는 노드포트
`노드 포트` 서비스를 설정하면 모든 워커 노드의 특정 포트(노드포트)를 열고 여기로 오는 모든 요청을 노드포트 서비스로 전달한다.

### 노드포트 서비스로 외부에서 접속하기

```shell
# m-k8s at super putty
kubectl create deployment np-pods --images=sysnet4admin/echo-hname
kubectl get pods
kubectl create -f ~/BookInfra/ch3/3.3.1/nodeport.yaml
kubectl get services
kubectl get nodes -o wide
```
1. 디플로이먼트로 파드를 생성한다. 이때 이미지는 sysnet4admin 계정에 있는 echo-hname 을 사용한다.
2. 배포된 파드를 확인한다.
3. kubectl cretae 노드포트 서비스를 생성한다. 편의를 위해 이미 정의한 오브젝트 스펙을 이용한다.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: np-svc
spec:
  selector:
    app: np-pods 
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 80
      nodePort: 30000
  type: NodePort
```
- metadata.name: 서비스 이름
- spec.selector: 셀렉터의 레이블 지정
- spec.ports: 사용할 프로토콜과 포트들을 지정
- spec.type: 서비스 타입을 설정
    > 기존 파드 구조에서 kind 가 Service 로 바뀌었고, spec 에 컨테이너에 대한 정보가 없다.
    > 그리고 접속에 필요한 네트워크 관련 정보(protocol, port, targetPort, nodePort) 와 서비스의 type 을 NodePort 로 지정했다.

4. kubectl get services 를 실행해 노드포트 서비스로 생성한 np-svc 서비스를 확인한다.
- `PORT(S)` 컬럼에서 노드포트의 포트 번호 확인한다. `CLUSTER-IP` 는 쿠버네티스 클러스터의 내부에서 사용하는 IP로, 자동으로 지정된다.
5. 쿠버네티스 클러스터의 워커 노드 IP 를 확인한다.
```http request
192.168.1.101 ~ 103
```
6. 호스트 노트북에서 웹 브라우저를 띄우고 192.168.1.101~103(확인한 워커 노드의 IP)와 30000번(노트포트의 포트 번호)으로 접속해 외부에서 접속되는지 확인한다.
화면에 파드 이름이 표시되는지도 확인한다. 이때 파드가 하나이므로 화면에 보이는 이름은 모두 동일하다.

### 부하 분산 테스트하기
### expose 로 노드포트 서비스 생성하기

## ✅ 사용 목적별로 연결하는 인그레스
## ✅ 클라우드에서 쉽세 구성 가능한 로드밸런서
## ✅ 온프레미스에서 로드밸런서를 제공하는 MetalLB
## ✅ 부하에 따라 자동으로 파드 수를 조절하는 HPA

