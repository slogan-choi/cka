# 도커로 컨테이너 다루기
- 컨테이너 이미지와 컨테이너의 관계: 컨테이너 이미지는 그대로는 사용할 수 없고, 도커와 같은 CRI로 불러들여야 컨테이너가 실제로 작동한다.
따라서 컨테이너를 삭제할 때는 내려받은 이미지와 이미 실행된 컨테이너를 모두 삭제해야만 디스크의 용량을 온전히 확보할 수 있다.

## ✅ 컨테이너 이미지 알아보기
### 이미지 검색하고 내려받기
이미지는 레지스트리(registry)라고 하는 저장소에 모여 있다.
```shell
# m-k8s at super putty
docker search nginx
```
1. 현재 사용할 수 있는 nginx 이미지를 검색

- `INDEX`: 이미지가 저장된 레지스트리의 이름
- `NAME`: 검색된 이미지 이름, 공식 이미지를 제외한 나머지는 '레지스트리 주소/저장소 소유자/이미지 이름' 형태
- `DESCRIPTION`: 이미지에 대한 설명
- `STARS`: 해당 이미지를 내려받은 사용자에게 받은 평가 횟수
- `OFFICIAL`: [OK] 표시는 해당 이미지에 포함된 애플리케이션, 미들웨어 등을 개발한 업체에서 공식적으로 제공한 이미지라는 의미
- `AUTOMATED`: [OK] 표시는 도커 허브에서 자체적으로 제공하는 이미지 빌드 자동화 기능을 활용해 생성한 이미지를 의미

```shell
# m-k8s at super putty
docker pull nginx
```
1. docker search 로 찾은 이미지를 docker pull 로 내려받을 수 있다.

- `tag`: Using default tag 와 함께 뒤에 따라오는 태그 이름을 통해 이미지를 내려받을 때 사용한 태그를 알 수 있다. 아무런 조건을 주지 않고 이미지 이름만으로 pull을 수행하면 기본으로 latest 태그가 적용된다.
- `layer`: pull 을 수행해 내려받은 레이어이다. 하나의 이미지는 여러 개의 레이어로 이루어져 있어서 레이어마다 Pull complete 메시지가 발생한다.
- `digest`: 이미지의 고유 식별자로, 이미지에 포함된 내용과 이미지의 생성 환경을 식별할 수 있다. 식별자는 해시함수로 생성되며 이미지가 동일한지 검증하는데 사용한다.
- `status`: 이미지를 내려받은 레지스트리, 이미지, 태그 등의 상태 정보를 확인할 수 있다. 형식은 '레지스트리 이름/이미지 이름:태그' 이다.

### 이미지 태그
`태그`는 이름이 동일한 이미지에 추가하는 식별자이다. 이름이 동일해도 도커 이미지의 버전이나 플랫폼(CPU 종류나 기본 베이스를 이루는 운영 체제 등)이 다를 수 있기 때문에 이를 구분하는 데 사용한다.
이미지를 내려받거나 이미지를 기반으로 컨테이너를 구동할 때는 이미지 이름만 사용하고 태그를 명시하지 않으면 latest 태그를 기본으로 사용한다.

### 이미지의 레이어 구조
이미지는 같은 내용일 경우 여러 이미지에 `동일한 레이어를 공유`하므로 전체 용량이 감소한다.
도커로 작성된 컨테이너는 레이어를 재사용하기 때문에 여러 이미지를 내려받더라도 디스크 용량을 효율적으로 사용할 수 있다.

```shell
# 이미지의 레이어 구조 확인하기
# m-k8s at super putty
docker pull nginx:stable
docker images nginx
docker history nginx:stable
docker history nginx:latest
```
1. stable 이미지를 내려받는다.
2. 내려받은 이미지를 조회한다.
3. stable 이미지가 어떤 과정을 거쳐 생성됐는지 확인한다.
4. latest 이미지의 생성 과정과 용량을 확인한다.

## ✅ 컨테이너 실행하기

### 컨테이너 단순히 실행하기
```shell
# m-k8s at super putty
docker run -d --restart always nginx
docker ps
docker ps -f id=cec7
curl 127.0.0.1
```
1. 새로운 컨테이너를 실행한다.
   - -d(--detach): 컨테이너를 백그라운드에서 구동한다는 의미이다.
   - --restart always: 컨테이너의 재시작과 관련된 정책을 의미하는 옵션이다.

Tip. --restart 옵션에 따라 달라지는 컨테이너 시작 방법

| 값 | 컨테이너 비정상 종료 시 | 도커 서비스 시작 시 |
|---|---|---|
| no(기본값) | 컨테이너를 재시작하지 않음 | 컨테이너를 시작하지 않음 |
| on-failure | 컨테이너를 재시작함 | 컨테이너를 시작함 |
| always | 컨테이너를 재시작함 | 컨테이너를 시작함 |
| unless-stopped | 컨테이너를 재시작함 | 사용자가 직접 정지하지 않은 컨테이너만 시작함 |

2. docker ps 명령으로 생성한 컨테이너 상태를 확인한다.
- `CONTAINER ID`: 컨테이너를 식별하기 위한 고유 ID 이다.
- `IMAGE`: 컨테이너를 만드는데 사용한 이미지
- `COMMAND`: 컨테이너가 생성될 때 내부에서 작동할 프로그램을 실행하는 명령어
- `CREATED`: 컨테이너가 생성된 시각을 표시
- `STATUS`: 컨테이너가 작동을 시작한 시각을 표시한다. 컨테이너가 중지했다가 다시 시작할 경우 초기화된다.
- `PORTS`: 컨테이너가 사용하는 포트와 프로토콜을 표시한다.
- `NAMES`: 컨테이너 이름을 표시한다. docker run 에 --name <이름> 옵션으로 직접 지정할 수도 있지만, 지정하지 않으면 컨테이너가 시작될 때 도커가 임의로 부여한 값이 나타난다.

3. docker ps -f id=cec7 명령으로 컨테이너를 지정해 검색한다. (16진수 ID를 넣어야 한다.)
docker ps -f(--filter) <필터링 대상> 옵션을 주면 검색 결과를 필터링 할 수 있다.

Tip. 자주 사용하는 필터링 키

필터링에 주로 사용하는 키(key) 는 다음과 같다.
- `id`: 컨테이너 아이디
- `name`: 컨테이너 이름
- `label`: 컨테이너 레이블
- `exited`: 컨테이너가 종료됐을 때 반환하는 숫자 코드
- `status`: 컨테이너의 자동 상태
- `ancestor`: 컨테이너가 사용하는 이미지

4. 생성된 nginx 컨테이너는 마스터 노드 내부에 존재하므로 curl 127.0.0.1 명령으로 컨테이너가 제공하는 nginx 웹 페이지 정보를 가지고 오게 한다. `에러 발생`
- 앞에서 컨테이너의 PORTS 열에 표시되는 80/tcp 는 컨테이너 내부에서 TCP 프로토콜의 80번 포트를 사용한다는 의미이다. 하지만 curl 127.0.0.1 로 전달한 요청은 로컬 호스트(127.0.0.1)의 80번 포트로 전달만 될 뿐 컨테이너까지는 도달하지 못한다.
즉 `호스트에 도달한 후 컨테이너로 도달하기 위한 추가 경로 설정이 돼 있지 않다.`

### 추가로 경로를 설정해 정상적으로 컨테이너 실행하기
```shell
# m-k8s at super putty
```


## ✅ 컨테이너 내부 파일 변경하기


## ✅ 사용하지 않는 컨테이너 정리하기


